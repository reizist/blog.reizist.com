<!DOCTYPE html>
<html lang="jp">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <script type="application/javascript" src='https://blog.reizist.com/js/theme-mode.js'></script>
    <link rel="stylesheet" href='https://blog.reizist.com/css/frameworks.min.css' />
    <link rel="stylesheet" href='https://blog.reizist.com/css/github.min.css' />
    <link rel="stylesheet" href='https://blog.reizist.com/css/github-style.css' />
    <link rel="stylesheet" href='https://blog.reizist.com/css/light.css' />
    <link rel="stylesheet" href='https://blog.reizist.com/css/dark.css' />
    <link rel="stylesheet" href='https://blog.reizist.com/css/syntax.css' />
    <title>GCP上でIAMキー無しでAWSコマンドを叩く方法 - reizist&#39;s memo</title>
    
    <link rel="icon" type="image/x-icon" href='https://blog.reizist.com/images/favicon.ico'>
    
    <meta name="theme-color" content="#1e2327">

    
    <meta name="description"
  content="AWS Security Token Service(STS)を使って、GCPのservice accountから一時的なAWS認証情報を生成し 実質service accountがAWS IAMのように振る舞うような状態にする。
実装そのものはここにおいてある。
" />
<meta name="keywords"
  content='' />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://blog.reizist.com/post/how-to-exec-aws-command-on-gcp-with-aws-iamkey-less/" />


<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="GCP上でIAMキー無しでAWSコマンドを叩く方法 - reizist&#39;s memo" />
<meta name="twitter:description"
  content="AWS Security Token Service(STS)を使って、GCPのservice accountから一時的なAWS認証情報を生成し 実質service accountがAWS IAMのように振る舞うような状態にする。
実装そのものはここにおいてある。
" />
<meta name="twitter:site" content="https://blog.reizist.com/" />
<meta name="twitter:creator" content="" />
<meta name="twitter:image"
  content="https://blog.reizist.com/">


<meta property="og:type" content="article" />
<meta property="og:title" content="GCP上でIAMキー無しでAWSコマンドを叩く方法 - reizist&#39;s memo">
<meta property="og:description"
  content="AWS Security Token Service(STS)を使って、GCPのservice accountから一時的なAWS認証情報を生成し 実質service accountがAWS IAMのように振る舞うような状態にする。
実装そのものはここにおいてある。
" />
<meta property="og:url" content="https://blog.reizist.com/post/how-to-exec-aws-command-on-gcp-with-aws-iamkey-less/" />
<meta property="og:site_name" content="GCP上でIAMキー無しでAWSコマンドを叩く方法" />
<meta property="og:image"
  content="https://blog.reizist.com/">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">

<meta property="article:published_time" content="2022-06-29 22:28:27 &#43;0900 &#43;0900" />












</head>

<body>
  <div style="position: relative">
  <header class="Header js-details-container Details px-3 px-md-4 px-lg-5 flex-wrap flex-md-nowrap open Details--on">
    <div class="Header-item mobile-none" style="margin-top: -4px; margin-bottom: -4px;">
      <a class="Header-link" href="https://blog.reizist.com/">
        <svg class="octicon" height="32" viewBox="0 0 16 16" version="1.1" width="32">
          <path fill-rule="evenodd"
            d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
          </path>
        </svg>
      </a>
    </div>
    <div class="Header-item d-md-none">
      <button class="Header-link btn-link js-details-target" type="button"
        onclick="document.querySelector('#header-search').style.display = document.querySelector('#header-search').style.display == 'none'? 'block': 'none'">
        <svg height="24" class="octicon octicon-three-bars" viewBox="0 0 16 16" version="1.1" width="24">
          <path fill-rule="evenodd"
            d="M1 2.75A.75.75 0 011.75 2h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 2.75zm0 5A.75.75 0 011.75 7h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 7.75zM1.75 12a.75.75 0 100 1.5h12.5a.75.75 0 100-1.5H1.75z">
          </path>
        </svg>
      </button>
    </div>
    <div style="display: none;" id="header-search"
      class="Header-item Header-item--full flex-column flex-md-row width-full flex-order-2 flex-md-order-none mr-0 mr-md-3 mt-3 mt-md-0 Details-content--hidden-not-important d-md-flex">
      <div
        class="Header-search header-search flex-auto js-site-search position-relative flex-self-stretch flex-md-self-auto mb-3 mb-md-0 mr-0 mr-md-3 scoped-search site-scoped-search js-jump-to">
        <div class="position-relative">
          <form target="_blank" action="https://www.google.com/search" accept-charset="UTF-8" method="get"
            autocomplete="off">
            <label
              class="Header-search-label form-control input-sm header-search-wrapper p-0 js-chromeless-input-container header-search-wrapper-jump-to position-relative d-flex flex-justify-between flex-items-center">
              <input type="text"
                class="Header-search-input form-control input-sm header-search-input jump-to-field js-jump-to-field js-site-search-focus js-site-search-field is-clearable"
                name="q" value="" placeholder="Search" autocomplete="off">
              <input type="hidden" name="q" value="site:https://blog.reizist.com/">
            </label>
          </form>
        </div>
      </div>
    </div>

    <div class="Header-item Header-item--full flex-justify-center d-md-none position-relative">
      <a class="Header-link " href="https://blog.reizist.com/">
        <svg class="octicon octicon-mark-github v-align-middle" height="32" viewBox="0 0 16 16" version="1.1"
          width="32">
          <path fill-rule="evenodd"
            d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
          </path>
        </svg>
      </a>
    </div>
    <div class="Header-item" style="margin-right: 0;">
      <a href="javascript:void(0)" class="Header-link no-select" onclick="switchTheme()">
        <svg style="fill: var(--color-profile-color-modes-toggle-moon);" class="no-select" viewBox="0 0 16 16"
          version="1.1" width="16" height="16">
          <path fill-rule="evenodd" clip-rule="evenodd"
            d="M4.52208 7.71754C7.5782 7.71754 10.0557 5.24006 10.0557 2.18394C10.0557 1.93498 10.0392 1.68986 10.0074 1.44961C9.95801 1.07727 10.3495 0.771159 10.6474 0.99992C12.1153 2.12716 13.0615 3.89999 13.0615 5.89383C13.0615 9.29958 10.3006 12.0605 6.89485 12.0605C3.95334 12.0605 1.49286 10.001 0.876728 7.24527C0.794841 6.87902 1.23668 6.65289 1.55321 6.85451C2.41106 7.40095 3.4296 7.71754 4.52208 7.71754Z">
          </path>
        </svg>
      </a>
    </div>
  </header>
</div>
  
<script src="https://unpkg.com/@popperjs/core@2"></script>
<script src="https://unpkg.com/tippy.js@6"></script>
<div>
  <main>
    <div class="gisthead pagehead bg-gray-light pb-0 pt-3 mb-4">
      <div class="px-0">
        <div class="mb-3 d-flex px-3 px-md-3 px-lg-5">
          <div class="flex-auto min-width-0 width-fit mr-3">
            <div class="d-flex">
              <div class="d-none d-md-block">
                <a class="avatar mr-2 flex-shrink-0" href="https://blog.reizist.com/">
                  <img class=" avatar-user"
                    src="https://blog.reizist.com/images/avatar.png"
                    width="32" height="32"></a>
              </div>
              <div class="d-flex flex-column">
                <h1 class="break-word f3 text-normal mb-md-0 mb-1">
                  <span class="author">
                    <a href="https://blog.reizist.com/">reizist</a></span><span
                    class="path-divider">/</span><strong class="css-truncate-target mr-1" style="max-width: 410px"><a
                      href="https://blog.reizist.com/post/how-to-exec-aws-command-on-gcp-with-aws-iamkey-less/">GCP上でIAMキー無しでAWSコマンドを叩く方法</a></strong>
                </h1>
                <div class="note m-0">
                  Created <relative-time datetime="Wed, 29 Jun 2022 22:28:27 &#43;0900"
                    class="no-wrap">
                    Wed, 29 Jun 2022 22:28:27 &#43;0900</relative-time>

                  
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container-lg px-3 new-discussion-timeline">
      <div class="repository-content gist-content">
        <div>
          <div class="js-gist-file-update-container js-task-list-container file-box">
            <div id="file-pytest" class="file my-2">
              <div id="post-header" class="file-header d-flex flex-md-items-center flex-items-start sticky-header">
                <div class="file-info d-flex flex-md-items-center flex-items-start flex-order-1 flex-auto">
                  <div class="text-mono f6 flex-auto pr-3 flex-order-2 flex-md-order-1 mt-2 mt-md-0">
                    
                    <summary id="toc-toggle" class="btn btn-octicon m-0 mr-2 p-2" aria-haspopup="menu" aria-label="Table of Contents" role="button">
                      <svg aria-hidden="true" viewBox="0 0 16 16" height="16" width="16" class="octicon octicon-list-unordered">
                        <path fill-rule="evenodd" d="M2 4a1 1 0 100-2 1 1 0 000 2zm3.75-1.5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zm0 5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zm0 5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zM3 8a1 1 0 11-2 0 1 1 0 012 0zm-1 6a1 1 0 100-2 1 1 0 000 2z"></path>
                      </svg>
                    </summary>
                          1301 Words
                    

                  </div>
                  <div class="file-actions flex-order-2 pt-0">
                    
                  </div>
                </div>
              </div>


              <div class="Box-body px-5 pb-5">
                <article class="markdown-body entry-content container-lg"><p>AWS Security Token Service(STS)を使って、GCPのservice accountから一時的なAWS認証情報を生成し
実質service accountがAWS IAMのように振る舞うような状態にする。</p>

<p>実装そのものは<a href="https://gist.github.com/reizist/e7dfc77dc5b0267b4083044356fb77cc">ここ</a>においてある。</p>

<p>以下詳細。</p>

<h2 id="事前準備">事前準備</h2>

<ul>
<li>GCP側で使用するservice accountのunique idをメモる</li>
</ul>

<p><img src="unique_id.png" alt="UniqueId" /></p>

<ul>
<li>AWS側でIAM roleを作成する</li>
</ul>

<p><img src="create_iam_role.png" alt="CreateIamRole" /></p>

<p>作られるエンティティはこう</p>

<pre><code class="language-json">{
    &quot;Version&quot;: &quot;2012-10-17&quot;,
    &quot;Statement&quot;: [
        {
            &quot;Effect&quot;: &quot;Allow&quot;,
            &quot;Action&quot;: &quot;sts:AssumeRoleWithWebIdentity&quot;,
            &quot;Principal&quot;: {
                &quot;Federated&quot;: &quot;accounts.google.com&quot;
            },
            &quot;Condition&quot;: {
                &quot;StringEquals&quot;: {
                    &quot;accounts.google.com:sub&quot;: [
                        &quot;unique_id&quot;
                    ],
                    &quot;accounts.google.com:aud&quot;: [
                        &quot;sts.amazonaws.com&quot;
                    ]
                }
            }
        }
    ]
}
</code></pre>

<p>ただしこのままだと動かず、Conditionを手動で編集して
<code>accounts.google.com:aud</code> の部分を削除したら動いた。</p>

<pre><code class="language-json">{
    &quot;Version&quot;: &quot;2012-10-17&quot;,
    &quot;Statement&quot;: [
        {
            &quot;Effect&quot;: &quot;Allow&quot;,
            &quot;Action&quot;: &quot;sts:AssumeRoleWithWebIdentity&quot;,
            &quot;Principal&quot;: {
                &quot;Federated&quot;: &quot;accounts.google.com&quot;
            },
            &quot;Condition&quot;: {
                &quot;StringEquals&quot;: {
                    &quot;accounts.google.com:sub&quot;: [
                        &quot;unique_id&quot;
                    ]
                }
            }
        }
    ]
}
</code></pre>

<p>実際にGCP上で取得できるpayloadとしては</p>

<pre><code>{'aud': 'sts.amazonaws.com', 'azp': 'your_sa_name@PJ.iam.gserviceaccount.com', 'email': 'your_sa_name@PJ.iam.gserviceaccount.com', 'email_verified': True, 'exp': xxx, 'iat': xxx, 'iss': 'https://accounts.google.com', 'sub': 'unique_id'}
</code></pre>

<p>という形式になっていて、
<code>aud</code> にはパラメータで指定したaudienceが、 <code>sub</code> には使用するservice accountのunique idが格納されているが、
policy上 <code>aud</code> と <code>sub</code> 両方でStringMatchしたほうが硬いとは思っている。</p>

<p>Audienceというパラメータは
<a href="https://cloud.google.com/compute/docs/instances/verifying-instance-identity?hl=ja#curl">AWS Doc</a>によれば</p>

<blockquote>
<p>AUDIENCE: インスタンスとインスタンスの ID を確認するシステムとの両方によって合意された一意の URI。たとえば、2 つのシステムの接続に使われる URL などです。</p>
</blockquote>

<p>とあるので <code>sts.amazonaws.com</code> を採用してみたのだけど、</p>

<p><a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_iam-condition-keys.html">また別のAWS Doc</a>に言わせれば　</p>

<blockquote>
<p>aud for OAuth 2.0 Google client IDs of your application, when the azp field is not set. When the azp field is set, the aud field matches the accounts.google.com:oaud condition key.</p>
</blockquote>

<p>と書いてあったりしてよくわかっていない。</p>

<p><a href="https://developers.google.com/identity/protocols/oauth2/openid-connect">GCP Doc</a>には</p>

<blockquote>
<p>この ID トークンの対象オーディエンス。アプリケーションの OAuth 2.0 クライアント ID のいずれかにする必要があります。</p>
</blockquote>

<p>とあるので、少なくとも特定のSAのtokenであることを検証するのは <code>sub</code> を使うのがいいんじゃないかとは思う。
現時点では <code>aud</code> の扱いはわかっていないので詳しい方は <a href="https://twitter.com/reizist">https://twitter.com/reizist</a> まで教えてくれると助かりますm(__)m</p>

<p>あとは必要に応じて更にpolicyをattachする。(今回はS3 Full Accessをつけて検証している)</p>

<h2 id="実行">実行</h2>

<p>準備は上記だけでよくて、あとはscriptを実行すると動く。</p>

<pre><code>❯ ASSUME_ROLE_ARN=arn:aws:iam::xxxx:role/your_role S3_BUCKET=your_s3_bucket python s3_ls.py
s3.ObjectSummary(bucket_name='your_s3_bucket', key='xxx')
</code></pre>

<h2 id="補足">補足</h2>

<p><a href="https://gist.github.com/reizist/e7dfc77dc5b0267b4083044356fb77cc">https://gist.github.com/reizist/e7dfc77dc5b0267b4083044356fb77cc</a>
の補足としては、</p>

<p><code>get_id_token()</code> と <code>get_id_token_via_metadata()</code> が両方実装してあって、
前者はservice accountからWebIdentity tokenを取得するメソッド、
後者はGCP上の環境から取得するメソッドになっているが現時点ではローカル環境から動かしているため <code>get_id_token()</code> を採用している。
実際にはCloudRun上でaws commandを叩きたいためにこの調査をしているので、CloudRunに設定したservice accountを使いたいため <code>get_id_token_via_metadata()</code> を使うことになりそう。（※ compute engineでしか試したことないけど、 <a href="https://cloud.google.com/run/docs/securing/service-identity?hl=ja#identity-tokens">CloudRunでもメタデータサーバー参照できそう</a> )</p>

<p>あとは、CloudRunのendpointにrequestを飛ばすたびにtokenを取得しなおすかどうかはもう少し考えたい(毎request token生成は余計な処理な気はするのでどこかにキャッシュさせたく、ディレクトリ書き込みしてみたりSecretManagerに書き込んでみたりしてみたい)。</p>

<h2 id="参考">参考</h2>

<ul>
<li><a href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/sts.html#STS.Client.assume_role_with_web_identity">boto3 doc</a></li>
<li><a href="https://cloud.google.com/compute/docs/instances/verifying-instance-identity?hl=ja#curl">インスタンスIDの確認</a></li>
<li><a href="https://google-auth.readthedocs.io/en/master/_modules/google/oauth2/service_account.html#Credentials">google-auth doc</a></li>
</ul></article>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>
<script>
 
 
 
 window.onload = function () {
   const header = document.getElementById('post-header');
   const headerHeight = header.offsetHeight;
   
   document.documentElement.style.scrollPaddingTop = headerHeight + 10 + "px";
 }

 const tocToggleButton = document.getElementById("toc-toggle");

 const tippyInstance = tippy('#toc-toggle', {
  trigger: 'click',
  content: '<div id="table-of-contents">\x3cnav id=\x22TableOfContents\x22\x3e\n\x3cul\x3e\n\x3cli\x3e\n\x3cul\x3e\n\x3cli\x3e\x3ca href=\x22#事前準備\x22\x3e事前準備\x3c\/a\x3e\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22#実行\x22\x3e実行\x3c\/a\x3e\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22#補足\x22\x3e補足\x3c\/a\x3e\x3c\/li\x3e\n\x3cli\x3e\x3ca href=\x22#参考\x22\x3e参考\x3c\/a\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\x3c\/li\x3e\n\x3c\/ul\x3e\n\x3c\/nav\x3e</div>',
  allowHTML: true,
  placement: 'bottom-start',
  interactive: true,
  arrow: false,
  maxWidth: "none",
  onHide: function () { tocToggleButton.classList.remove("hover"); },
  onShow: function () { tocToggleButton.classList.add("hover"); },
  onShown: function () {
    selectTableOfContentsOption();

    if (window.hasSetupTableOfContentsListeners) {
      return;
    }

    const tableOfContents = document.getElementById("table-of-contents");
    tableOfContents.addEventListener('click', function () {
      
      tippyInstance[0].hide();
    });

    window.hasSetupTableOfContentsListeners = true;
  }
 });

 function selectTableOfContentsOption () {
   const optionSelectedClass = 'table-of-contents-option-selected';

   const tableOfContentsOptions = document.querySelectorAll("#table-of-contents > nav > ul li");

   for (const option of tableOfContentsOptions) {
     

     const [child] = option.children;
     if (child.tagName.toLowerCase() !== 'a') {
       continue;
     }

     if (window.location.href === child.href) {
       child.classList.add(optionSelectedClass);
     } else {
       child.classList.remove(optionSelectedClass);
     }
   }
 }

 window.onhashchange = selectTableOfContentsOption;
</script>


  <div class="footer container-xl width-full p-responsive">
  <div
    class="position-relative d-flex flex-row-reverse flex-lg-row flex-wrap flex-lg-nowrap flex-justify-center flex-lg-justify-between flex-sm-items-center pt-6 pb-2 mt-6 f6 text-gray border-top border-gray-light ">
    <a aria-label="Homepage" title="GitHub" class="footer-octicon d-none d-lg-block mr-lg-4" href="https://blog.reizist.com/">
      <svg height="24" class="octicon octicon-mark-github" viewBox="0 0 16 16" version="1.1" width="24">
        <path fill-rule="evenodd"
          d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
        </path>
      </svg>
    </a>
    <ul class="list-style-none d-flex flex-wrap col-12 flex-justify-center flex-lg-justify-between mb-2 mb-lg-0">
      
      <li class="mr-3 mr-lg-0">Theme by <a href='https://github.com/MeiK2333/github-style'>github-style</a></li>
      
    </ul>
  </div>
  <div class="d-flex flex-justify-center pb-6">
    <span class="f6 text-gray-light"></span>
  </div>


</div>
</body>

<script type="application/javascript" src="https://blog.reizist.com/js/github-style.js"></script>



</html>